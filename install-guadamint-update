#!/bin/bash

# Comprobación de root para la INSTALACIÓN
if [ "$EUID" -ne 0 ]; then
  echo "Por favor, ejecuta el instalador como root (sudo ./install.sh)"
  exit 1
fi

echo ">>> Instalando sistema de actualizaciones GuadaMint..."

# 0. INSTALAR DEPENDENCIAS (GIT)
# Vital para que funcione la auto-actualización del script Python
echo "Comprobando dependencias..."
if ! command -v git &> /dev/null; then
    echo "-> Git no encontrado. Instalando..."
    apt-get update
    apt-get install -y git
    if [ $? -eq 0 ]; then
        echo "-> Git instalado correctamente."
    else
        echo "¡ERROR CRÍTICO! No se pudo instalar git. El actualizador fallará."
        exit 1
    fi
else
    echo "-> Git ya está instalado. Correcto."
fi

# 1. DEFINIR RUTAS
SOURCE_DIR=$(dirname "$0")
DEST_BIN="/usr/bin/guadamint-update.py"  
DEST_DESKTOP="/etc/xdg/autostart/guadamint-update.desktop"
DEST_ICON="/usr/share/icons/guadamintuz.svg"
LOG_DIR="/var/log/guadamint"

# FUNCIÓN DE BÚSQUEDA INTELIGENTE
buscar_archivo() {
    local archivo=$1
    local subcarpeta=$2
    if [ -f "$SOURCE_DIR/$subcarpeta/$archivo" ]; then
        echo "$SOURCE_DIR/$subcarpeta/$archivo"
    elif [ -f "$SOURCE_DIR/$archivo" ]; then
        echo "$SOURCE_DIR/$archivo"
    else
        echo ""
    fi
}

# 2. CONFIGURAR SUDOERS
FILE_SUDOERS=$(buscar_archivo "zz-guadamint-update" "src")
SUDOERS_DEST="/etc/sudoers.d/zz-guadamint-update"

if [ -n "$FILE_SUDOERS" ]; then
    echo "Configurando permisos sudo con $FILE_SUDOERS..."
    cp "$FILE_SUDOERS" "$SUDOERS_DEST"
    chown root:root "$SUDOERS_DEST"
    chmod 0440 "$SUDOERS_DEST"
else
    echo "¡ERROR CRÍTICO! No se encontró el archivo 'zz-guadamint-update'."
    exit 1
fi

# 3. COPIAR EL SCRIPT PYTHON
FILE_PYTHON=$(buscar_archivo "guadamint-update.py" "src")

if [ -n "$FILE_PYTHON" ]; then
    echo "Copiando script $FILE_PYTHON a $DEST_BIN..."
    cp "$FILE_PYTHON" "$DEST_BIN"
    chmod 755 "$DEST_BIN"
else
    echo "¡ERROR CRÍTICO! No se encuentra 'guadamint-update.py'."
    exit 1
fi

# 4. COPIAR EL AUTOARRANQUE (.desktop)
FILE_DESKTOP=$(buscar_archivo "guadamint-update.desktop" "src")

if [ -n "$FILE_DESKTOP" ]; then
    echo "Copiando lanzador $FILE_DESKTOP a $DEST_DESKTOP..."
    cp "$FILE_DESKTOP" "$DEST_DESKTOP"
    chmod 644 "$DEST_DESKTOP"
else
    echo "¡ERROR CRÍTICO! No se encuentra 'guadamint-update.desktop'."
    exit 1
fi

# 5. INSTALAR ICONO
FILE_ICON=$(buscar_archivo "guadamintuz.svg" "images")
# Fallback: buscar el nombre antiguo por si acaso
if [ -z "$FILE_ICON" ]; then FILE_ICON=$(buscar_archivo "AndaTuz2.svg" "images"); fi

echo "Instalando icono en $DEST_ICON..."
if [ -n "$FILE_ICON" ]; then
    cp "$FILE_ICON" "$DEST_ICON"
    chmod 644 "$DEST_ICON"
    echo "-> Icono instalado."
else
    echo "AVISO: No se encontró el icono (guadamintuz.svg). Se usará genérico."
fi

# 6. CREAR DIRECTORIO DE LOGS
mkdir -p "$LOG_DIR"
chmod 777 "$LOG_DIR"

echo ">>> Instalación completada con éxito."
