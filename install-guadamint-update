#!/bin/bash

# Comprobación de root para la INSTALACIÓN
if [ "$EUID" -ne 0 ]; then
  echo "Por favor, ejecuta el instalador como root (sudo ./install.sh)"
  exit 1
fi

echo ">>> Instalando sistema de actualizaciones GuadaMint..."

# 1. DEFINIR RUTAS (ESTO SIEMPRE DEBE IR PRIMERO)
# Si no definimos esto aquí, los comandos de abajo fallarán.
SOURCE_DIR=$(dirname "$0")
DEST_BIN="/usr/bin/guadamint-update.py"  
DEST_DESKTOP="/etc/xdg/autostart/guadamint-update.desktop"
LOG_DIR="/var/log/guadamint"

# 2. CONFIGURAR SUDOERS (Permisos para actualizar sin contraseña)
# Usamos el archivo que tienes en src/
SUDOERS_SRC="$SOURCE_DIR/src/zz-guadamint-update"
SUDOERS_DEST="/etc/sudoers.d/zz-guadamint-update"

if [ -f "$SUDOERS_SRC" ]; then
    echo "Configurando permisos sudo..."
    cp "$SUDOERS_SRC" "$SUDOERS_DEST"
    chown root:root "$SUDOERS_DEST"
    chmod 0440 "$SUDOERS_DEST"
else
    echo "¡ADVERTENCIA! No se encontró $SUDOERS_SRC"
    echo "El actualizador fallará al pedir contraseña."
fi

# 3. COPIAR EL SCRIPT PYTHON
echo "Copiando script a $DEST_BIN..."
cp "$SOURCE_DIR/src/guadamint-update.py" "$DEST_BIN"
# Permisos 755 para que cualquiera pueda ejecutarlo
chmod 755 "$DEST_BIN" 

# 4. COPIAR EL AUTOARRANQUE (.desktop)
echo "Copiando lanzador a $DEST_DESKTOP..."
cp "$SOURCE_DIR/src/guadamint-update.desktop" "$DEST_DESKTOP"
chmod 644 "$DEST_DESKTOP"

# 5. INSTALAR ICONO
echo "Instalando icono en $DEST_ICON..."
if [ -f "$SOURCE_DIR/images/guadamintuz.svg" ]; then
    cp "$SOURCE_DIR/images/guadamintuz.svg" "$DEST_ICON"
    chmod 644 "$DEST_ICON"
else
    echo "AVISO: No se encontró el icono en $SOURCE_DIR/images/guadamintuz.svg"
fi

# 6. CREAR DIRECTORIO DE LOGS
# Usamos 777 porque el script lo ejecuta el ALUMNO, no root.
# Si pones 755, el alumno no tendrá permiso para escribir el log.
mkdir -p "$LOG_DIR"
chmod 777 "$LOG_DIR"

echo ">>> Instalación completada."
echo "El script reside en /usr/bin/guadamint-update.py y se ejecutará al iniciar sesión."
