#!/bin/bash

# Comprobación de root para la INSTALACIÓN
if [ "$EUID" -ne 0 ]; then
  echo "Por favor, ejecuta el instalador como root (sudo ./install.sh)"
  exit 1
fi

echo ">>> Instalando sistema de actualizaciones GuadaMint en /usr/bin..."

# 1. Definir rutas
SOURCE_DIR=$(dirname "$0")
DEST_BIN="/usr/bin/guadamint-update.py"  # <--- CAMBIO AQUÍ
DEST_SERVICE="/etc/systemd/system/guadamint-update.service"
LOG_DIR="/var/log/guadamint"

# 2. Copiar el script Python
echo "Copiando script a $DEST_BIN..."
cp "$SOURCE_DIR/src/guadamint-update.py" "$DEST_BIN"

# Permisos 755: rwxr-xr-x
# (Owner=root puede escribir/ejecutar, Grupo/Otros pueden leer/ejecutar)
chmod 755 "$DEST_BIN" 

# 3. Copiar el servicio Systemd
echo "Copiando servicio a $DEST_SERVICE..."
cp "$SOURCE_DIR/src/guadamint-update.service" "$DEST_SERVICE"
chmod 644 "$DEST_SERVICE"

# 4. Crear directorio de logs
# Esto es importante para que el script no falle al intentar crear el log
mkdir -p "$LOG_DIR"
chmod 755 "$LOG_DIR"

# 5. Activar el servicio
echo "Habilitando servicio systemd..."
systemctl daemon-reload
systemctl enable guadamint-update.service

echo ">>> Instalación completada."
echo "El script reside en /usr/bin/guadamint-update.py y se ejecutará como root al inicio."
